WITH base_group AS (SELECT cust, prod, SUM(quant) AS sum_quant, COUNT(quant) AS count_quant, AVG(quant) AS avg_quant FROM sales GROUP BY cust, prod), g1 AS (SELECT cust, prod, SUM(quant) AS sum_1_quant, COUNT(quant) AS count_1_quant, AVG(quant) AS avg_1_quant FROM sales WHERE state = 'NY' GROUP BY cust, prod), g2 AS (SELECT cust, prod, SUM(quant) AS sum_2_quant, AVG(quant) AS avg_2_quant FROM sales WHERE state = 'NJ' GROUP BY cust, prod), g3 AS (SELECT cust, prod, AVG(quant) AS avg_3_quant FROM sales WHERE state = 'CT' GROUP BY cust, prod) SELECT base_group.cust, base_group.prod, base_group.avg_quant, base_group.sum_quant, g1.sum_1_quant, g1.count_1_quant, g1.avg_1_quant, g2.avg_2_quant, g3.avg_3_quant FROM base_group JOIN g1 ON base_group.cust = g1.cust AND base_group.prod = g1.prod JOIN g2 ON base_group.cust = g2.cust AND base_group.prod = g2.prod JOIN g3 ON base_group.cust = g3.cust AND base_group.prod = g3.prod WHERE g1.sum_1_quant > 2 * g2.sum_2_quant OR g1.avg_1_quant > g3.avg_3_quant order by base_group.cust, base_group.prod