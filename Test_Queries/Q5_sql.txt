WITH base_group AS (SELECT cust, prod, SUM(quant) AS sum_quant, COUNT(quant) AS count_quant, AVG(quant) AS avg_quant FROM sales GROUP BY cust, prod), g1 AS (SELECT cust, prod, SUM(quant) AS sum_1_quant, COUNT(quant) AS count_1_quant FROM sales WHERE state = 'NY' GROUP BY cust, prod), g2 AS (SELECT s.cust, s.prod, AVG(s.quant) AS avg_2_quant FROM sales s JOIN base_group bg ON s.cust = bg.cust AND s.prod = bg.prod WHERE s.state = 'NJ' AND s.quant > bg.avg_quant GROUP BY s.cust, s.prod), g3 AS (SELECT s.cust, s.prod, MAX(s.quant) AS max_3_quant FROM sales s JOIN g2 ON s.cust = g2.cust AND s.prod = g2.prod WHERE s.state = 'CT' AND s.quant < g2.avg_2_quant GROUP BY s.cust, s.prod) SELECT bg.cust, bg.prod, bg.avg_quant, g1.sum_1_quant, g1.count_1_quant, g2.avg_2_quant, g3.max_3_quant FROM base_group bg JOIN g1 ON bg.cust = g1.cust AND bg.prod = g1.prod JOIN g2 ON bg.cust = g2.cust AND bg.prod = g2.prod JOIN g3 ON bg.cust = g3.cust AND bg.prod = g3.prod WHERE g2.avg_2_quant > 500 AND g3.max_3_quant > bg.avg_quant order by bg.cust, bg.prod