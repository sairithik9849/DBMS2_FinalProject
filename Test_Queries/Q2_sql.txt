WITH base_group AS (SELECT cust, prod, SUM(quant) AS sum_quant, COUNT(quant) AS count_quant, AVG(quant) AS avg_quant FROM sales GROUP BY cust, prod), g1 AS (SELECT s.cust, s.prod, SUM(s.quant) AS sum_1_quant FROM sales s JOIN base_group bg ON s.cust = bg.cust AND s.prod = bg.prod WHERE s.quant > bg.avg_quant GROUP BY s.cust, s.prod) SELECT bg.cust, bg.prod, bg.sum_quant, g1.sum_1_quant AS sum_1_quant FROM base_group bg LEFT JOIN g1 ON bg.cust = g1.cust AND bg.prod = g1.prod order by bg.cust, bg.prod